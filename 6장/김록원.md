# 6장 - 파티셔닝

# 정리

> [!info] 파티셔닝 이란
> 하나의 큰 데이터셋을 여러 데이터 셋으로 쪼개어 각기 다른 데이터베이스에 저장하는 방법.
> 이를 통해, 각 부하 분산의 효과를 얻을 수 있다. 이론적으로는 10개로 파티션을 나누면 10배의 성능이 향상된다고 볼 수 있다. 각 파티션 마다 앞서 배운 복제를 적용할 수도 있다.

### 데이터 파티셔닝 방법
파티셔닝의 목적은 데이터와 질의 부하를 각 노드에 고르게 분산시키는 것이다. 때문에 데이터와 질의가 한 파티션에 쏠리는 현상(skewed, 이렇게 쏠린 현상이 발생한 파티션을 핫스팟이라고 부른다.)을 회피하는 것이 중요하다.
- `키 범위 기준 파티셔닝`
  각 파티션에 연속된 범위의 키를 할당하는 방법
	- 장점
		- 각 범위 사이의 경계를 알면 어떤 키가 어느 파티션에 속하는지 쉽게 알 수 있다.
		- 각 파티션 내에서 키가 정렬된 순서로 저장된다. - 범위 스캔이 쉽다!
	- 단점
		- 특정한 접근 패턴에서 핫스팟 유발!
		- 키가 연속적 = 시간 순 이라 특정 시간에는 특정 데이터베이스에 쓰기가 몰리는 현상이 발생가능하다
		- 위 문제를 해결하기 위해 키 앞에 또 다른 분류 접두사를 붙여 분산 저장하도록 해야한다.
- `키의 해시값 기준 파티셔닝`
  키의 파티션을 정하는데 해시함수를 사용. 각 파티션은 해싱값의 한 범위를 담당한다.
	- 장점
		- 키를 해싱하므로 파티션에 거의 고르게 분배된다.
	- 단점
		- `키 범위 기준 파티셔닝`의 장점인 범위 스캔이 힘들다. - 연속적이지 않고 여러 데이터베이스에 저장되므로
		- 카산드라의 경우 복합 기본키를 사용하여 부분적으로 범위스캔이 가능하도록 만든다.(첫번째키를 해싱될 키, 두번째키를 타입스탬프)

키를 고르게 분배한다고 하여도 부하가 한 파티션으로 쏠려 핫스팟이 될 수 있다. 예를 들어, 유명인 문제가 있다. 한 유명인 키에 막대한 양의 데이터가 기록되어 사용자들이 해당 유명인에 대한 정보를 받기 위한 작업을 하게된다면 같은 키를 가지는 정보이므로 하나의 파티션에 몰린다.
이러한 작업부하를 완화시키기 위해 해당 키의 끝에에 임의의 10진수 두 개를 붙이는 방법이 있다. 이렇게 되면 100개의 다른 키로 분산되어 저장되지만 읽기 시 분산된 값들을 조합해야 하며, 한 키가 여러 파티션으로 분산되었다는 것을 추적하기 위한 방법도 필요하다. 

### 보조색인 존재한다면?
앞서 파티셔닝 방식들은 키-값 데이터 모델에 의존한다. 하지만 키 뿐만 아니라 보조색인이 있다면 파티셔닝은 복잡해진다. 보조색인은 유일한 식별자가 아니라 보통 특정한 값이 발생한 항목을 검색하는 수단으로 많이 쓰인다. 이러한 보조 색인은 파치션에 깔끔하게 대응되지 않는다.

- 문서 기준 보조 색인 파티셔닝 (지역 색인)
	- 키를 기준으로 파티셔닝 후, 각 파티션마다 자신의 문서만 담당한다.
	- 동일한 보조색인을 가지더라도 여러 파티션에 분산 저장되므로 읽기 시에 모든 파티션을 검색해야한다.
	- 보조 색인을 하나만 사용해서 질의할때는 그마다 나을 수도 있지만 여러 보조색인을 사용할때 검색이 복잡해진다.
- 용어 기준 보조 색인 파티셔닝 (전역 색인)
	- 키를 기준으로 파티셔닝, 각 파티셔닝마다 보조색인에 대한 파티션도 따로 담당한다.
	- 한 보조색인에 대해서는 하나의 파티션에 저장되므로 읽기가 수월하다.
	- 하지만 쓰기 시(한 파티션에 데이터가 들어가면) 해당 데이터의 모든 보조색인에 대하여 다른 파티션에도 쓰기가 일어난다.
	- 쓰기가 여러번 일어나 분산 트랜잭션이 필요하지만 이를 지원하지 않는 DB도 있다.
	- 여러 번의 쓰기는 대게 비동기로 갱신되도록 만든다.

### 재균형화
다음과 같은 일로 재균형화가 일어날 수 있다.(처리속도 향상을 위해)
- 질의량 증가
- 데이터 셋이 증가
- 장비에 장애 발생

재균형화 전략
- `파티션 개수 고정`
  노드 수보다 많은 파티셔닝을 만들고 하나의 노드의 많은 파티셔닝을 가지는 방식.
  재균형화가 일어나면 새 노드를 추가하고 해당 노드로 파티션을 옮기는 방식.
  파티션의 갯수가 고정. 따라서 데이터셋의 크기가 커지면 개별 파티션의 크기도 커진다.
- `동적 파티셔닝`
  데이터의 크기에 따라 파티션의 개수가 변한다.
  파티션의 크기가 임계값 밑으로 떨어지면 인접한 파티션과 합치고 임계값보다 커지면 파티션을 분할한다.
- `노드 비례 파티셔닝`
  노드당 할당되는 파티션 개수를 고정한다. 노드 대수가 늘어나면 파티션의 갯수도 늘어난다. 새 노드가 클러스터에 추가되면 고정된 개수의 파티션을 무작위로 선택해 분할하고 분할된 절반을 새 노드에 할당한다.


### 요청 라우팅
어느 파티션으로 요청해야하는지 어떻게 알 수 있을까?(service discovery 문제)
- 무작위 노드로 보내고 해당 노드가 처리불가능하다면 올바른 노드로 전달(가십 프로토콜)
- 라우팅 계층을 두고 클라이언트는 이 라우팅 계층으로 접속(코디네이션)
- 클라이언트가 중개자 없이 올바른 노드로 직접 접속

---

# 스터디

### 기습 퀴즈(2개)
스터디 끝나고 난 후 커밋(답변과 함께)
- Q.
```text
승리: ???
록원: !!!
```  

- Q.
```text
승리: ???
록원: !!!
``` 


### 본인이 이해 안되었던 부분
- 

### 좀 더 공부한 부분
- 수직 파티셔닝과 수평 파티셔닝
  - 수직 파티셔닝은 서로 다른 모델을 다른 데이터베이스에 나누는 것이고 수평 파티셔닝은 같은 모델을 데이터만 여러 데이터베이스에 나누는 것

### 논의하고 싶은 부분
- 재균형화가 일어날때 모든 파티션의 복제본들도 함께 재균형화가 일어날까? 그럼 진짜 지각대변동인데..?
